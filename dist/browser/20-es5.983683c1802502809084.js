function _defineProperty(n,e,t){return e in n?Object.defineProperty(n,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):n[e]=t,n}function _defineProperties(n,e){for(var t=0;t<e.length;t++){var l=e[t];l.enumerable=l.enumerable||!1,l.configurable=!0,"value"in l&&(l.writable=!0),Object.defineProperty(n,l.key,l)}}function _createClass(n,e,t){return e&&_defineProperties(n.prototype,e),t&&_defineProperties(n,t),n}function _classCallCheck(n,e){if(!(n instanceof e))throw new TypeError("Cannot call a class as a function")}(window.webpackJsonp=window.webpackJsonp||[]).push([[20],{z6Qy:function(n,e,t){"use strict";t.r(e);var l=t("8Y7J"),o=function n(){_classCallCheck(this,n)},i=t("pMnS"),a=t("NvT6"),c=t("W5yJ"),s=t("/HVE"),u=t("SVse"),r=t("omvX"),d=t("bujt"),b=t("Fwaw"),p=t("5GAg"),m=t("Mr+X"),f=t("Gi4r"),v=t("KPQW"),h=t("FbN9"),C=t("BzsH"),g=t("2/pp"),x=t("xQwi"),w=t("VYsW"),y=t("ZJFI"),k=function(){function n(e,t,l,o,i,a,c){_classCallCheck(this,n),this.appContext=e,this.webRtcService=t,this.statusColor=l,this.database=o,this.changeRef=i,this.streamRecorderService=a,this.webRtcContext=c,this.localBadge="",this.toolbarVisibility=!1,this.subscriptions=[],this.buttons=[["video-off","video"],["audio-off","audio"]],this.t=void 0}return _createClass(n,[{key:"ngOnInit",value:function(){var n=this;this.videoContext.local&&this.subscriptions.push(this.appContext.announcements.subscribe((function(e){var t=e.filter((function(n){return n.active})).length;n.localBadge=0==t?"":t+""}))),this.subscriptions.push(this.videoContext.dataChannel.data.subscribe((function(e){if("settings"===e.type)"video"in e&&(n.videoContext.settings.video=e.video),"audio"in e&&(n.videoContext.settings.audio=e.audio),n.sendVisualData(e);else if("status"===e.type){var t=n.videoContext.contact.value;t.statusColor=e.statusColor,n.videoContext.contact.next(t),n.webRtcService.checkConnectionState({state:e.statusText,contact:t,videoContext:n.videoContext})}n.changeRef.detectChanges()})))}},{key:"ngOnDestroy",value:function(){this.subscriptions.forEach((function(n){return n.unsubscribe()})),this.stopRecording()}},{key:"clickIcon",value:function(n,e){var t;switch(e.stopImmediatePropagation(),n){case 0:var l=this.videoContext.stream.value.getVideoTracks()[0];l&&(l.enabled=!!(this.videoContext.settings.video=0==this.videoContext.settings.video?1:0)),t=this.videoContext.settings;break;case 1:var o=this.videoContext.stream.value.getAudioTracks()[0];o&&(o.enabled=!!(this.videoContext.settings.audio=0==this.videoContext.settings.audio?1:0)),t=this.videoContext.settings;break;case 2:this.webRtcService.stopVideoChannel(this.videoContext)}t&&(this.appContext.localVideoAudio=t,this.webRtcService.sendDataMessages(this.videoContext.wid,this.appContext.appUser.uid,t),this.sendVisualData(t))}},{key:"sendVisualData",value:function(n){"1"===window.localStorage.getItem("callSave")&&this.database.changeMessage(this.videoContext.messageUrl+"/metadata/"+this.videoContext.contact.value.uid+"/visual",_defineProperty({},Date.now(),{video:n.video,audio:n.audio}))}},{key:"onMoveElementVideo",value:function(n){var e=this;n.stopImmediatePropagation(),this.toolbarVisibility=!0,this.t&&clearTimeout(this.t),this.t=setTimeout((function(){e.toolbarVisibility=!1,clearTimeout(e.t),e.t=void 0,e.changeRef.detectChanges()}),5e3)}},{key:"onCloseView",value:function(n){this.webRtcContext.handleView(!0),n.stopImmediatePropagation()}},{key:"onLoadedData",value:function(n){this.videoContext.className.active=!0,this.videoContext.videoElement=n,"1"===window.localStorage.getItem("callSave")&&this.streamRecorderService.startRecodeStream({uid:this.videoContext.contact.value.uid,wid:this.videoContext.wid,mediaRecorders:this.webRtcContext.mediaRecorders,stream:this.videoContext.stream.value,local:this.videoContext.local,messageUrl:this.videoContext.messageUrl}),this.videoContext.local||this.webRtcService.checkVideoContexts(this.videoContext)}},{key:"stopRecording",value:function(){var n=this.webRtcContext.mediaRecorders[this.videoContext.contact.value.uid];n&&(n.mediaRecorder.stop(),delete this.webRtcContext.mediaRecorders[this.videoContext.contact.value.uid])}},{key:"onEnded",value:function(){this.videoContext.className.active=!1,this.webRtcService.checkVideoContexts(this.videoContext)}}]),n}(),I=t("hoN+"),_=t("tX6c"),A=t("H2Rr"),O=function(){function n(e){_classCallCheck(this,n),this.platformId=e,this.mediaRecorders={},this.localToolbar=!1}return _createClass(n,[{key:"ngOnInit",value:function(){}},{key:"handleView",value:function(n){this.context.videoCollection.find((function(n){return n.local})).className.closed=this.localToolbar=n}}]),n}(),R=l.ob({encapsulation:0,styles:[[".video-container[_ngcontent-%COMP%]{position:relative;flex:1 1 0;height:100%;display:flex;justify-content:center;align-items:center;overflow:hidden}.main-video-container[_ngcontent-%COMP%]{top:0;position:absolute;height:100%;width:100%;display:flex;justify-content:center;align-items:center}.top-toolbar[_ngcontent-%COMP%]{position:absolute;top:0;background:0 0;display:flex;align-items:center;justify-content:center;z-index:2}.bottom-local-block[_ngcontent-%COMP%]{width:160px;display:flex;justify-content:space-between;align-items:center}.bottom-peer-audio[_ngcontent-%COMP%], .bottom-peer-video[_ngcontent-%COMP%], .close-view[_ngcontent-%COMP%]{background-color:transparent!important}video.video-element[_ngcontent-%COMP%]{position:absolute;z-index:0;top:0;left:0;width:100%;height:100%;-o-object-fit:cover;object-fit:cover;-o-object-position:50% 50%;object-position:50% 50%;border:0 solid #cecece}.phone-hangup[_ngcontent-%COMP%]{background-color:#c60000!important}mat-icon[_ngcontent-%COMP%]{color:#fff!important}.bottom-toolbar.local[_ngcontent-%COMP%]{background:0 0;position:absolute;display:flex;justify-content:center;bottom:0}.bottom-toolbar.remote[_ngcontent-%COMP%]{position:absolute;background:0 0;display:flex;justify-content:center}.img-pulse[_ngcontent-%COMP%]{position:absolute;transform:scale(.9) rotate(-45deg);transform-origin:13px 88px;display:none}div.video-container.active.pulse[_ngcontent-%COMP%]   .img-pulse[_ngcontent-%COMP%]{display:initial}div.video-container.local.active[_ngcontent-%COMP%]{position:absolute;top:0;left:0;width:100%;height:100%;z-index:4;transition:.5s}div.video-container.local.active.fixed[_ngcontent-%COMP%]{bottom:0;left:0;width:200px;height:200px;top:unset}div.video-container.local.active.fixed.closed[_ngcontent-%COMP%]{width:0;height:0}"]],data:{}});function q(n){return l.Lb(0,[(n()(),l.qb(0,0,null,null,3,"button",[["class","close-view"],["mat-mini-fab",""]],[[1,"disabled",0],[2,"_mat-animation-noopable",null]],[[null,"click"]],(function(n,e,t){var l=!0;return"click"===e&&(l=!1!==n.component.onCloseView(t)&&l),l}),d.b,d.a)),l.pb(1,180224,null,0,b.b,[l.k,p.f,[2,r.a]],null,null),(n()(),l.qb(2,0,null,0,1,"mat-icon",[["class","mat-icon notranslate"],["role","img"],["svgIcon","close-view"]],[[2,"mat-icon-inline",null],[2,"mat-icon-no-color",null]],null,null,m.b,m.a)),l.pb(3,9158656,null,0,f.b,[l.k,f.d,[8,null],[2,f.a],[2,l.l]],{svgIcon:[0,"svgIcon"]},null)],(function(n,e){n(e,3,0,"close-view")}),(function(n,e){n(e,0,0,l.Cb(e,1).disabled||null,"NoopAnimations"===l.Cb(e,1)._animationMode),n(e,2,0,l.Cb(e,3).inline,"primary"!==l.Cb(e,3).color&&"accent"!==l.Cb(e,3).color&&"warn"!==l.Cb(e,3).color)}))}function P(n){return l.Lb(0,[(n()(),l.qb(0,0,null,null,5,null,null,null,null,null,null,null)),(n()(),l.qb(1,0,null,null,2,"mat-icon",[["class","mat-icon notranslate mat-badge"],["matBadgeSize","small"],["role","img"],["svgIcon","notifications"]],[[2,"mat-icon-inline",null],[2,"mat-icon-no-color",null],[2,"mat-badge-overlap",null],[2,"mat-badge-above",null],[2,"mat-badge-below",null],[2,"mat-badge-before",null],[2,"mat-badge-after",null],[2,"mat-badge-small",null],[2,"mat-badge-medium",null],[2,"mat-badge-large",null],[2,"mat-badge-hidden",null],[2,"mat-badge-disabled",null]],null,null,m.b,m.a)),l.pb(2,9158656,null,0,f.b,[l.k,f.d,[8,null],[2,f.a],[2,l.l]],{svgIcon:[0,"svgIcon"]},null),l.pb(3,671744,null,0,v.a,[l.x,l.k,p.c,l.C,[2,r.a]],{color:[0,"color"],content:[1,"content"],size:[2,"size"]},null),(n()(),l.gb(16777216,null,null,1,null,q)),l.pb(5,16384,null,0,u.l,[l.N,l.K],{ngIf:[0,"ngIf"]},null),(n()(),l.gb(0,null,null,0))],(function(n,e){var t=e.component;n(e,2,0,"notifications"),n(e,3,0,"accent",t.localBadge,"small"),n(e,5,0,t.videoContext.className.fixed)}),(function(n,e){n(e,1,1,[l.Cb(e,2).inline,"primary"!==l.Cb(e,2).color&&"accent"!==l.Cb(e,2).color&&"warn"!==l.Cb(e,2).color,l.Cb(e,3).overlap,l.Cb(e,3).isAbove(),!l.Cb(e,3).isAbove(),!l.Cb(e,3).isAfter(),l.Cb(e,3).isAfter(),"small"===l.Cb(e,3).size,"medium"===l.Cb(e,3).size,"large"===l.Cb(e,3).size,l.Cb(e,3).hidden||!l.Cb(e,3)._hasContent,l.Cb(e,3).disabled])}))}function S(n){return l.Lb(0,[(n()(),l.qb(0,0,null,null,4,null,null,null,null,null,null,null)),(n()(),l.qb(1,0,null,null,1,"mat-icon",[["class","video-peer-img mat-icon notranslate"],["role","img"]],[[2,"mat-icon-inline",null],[2,"mat-icon-no-color",null]],null,null,m.b,m.a)),l.pb(2,9158656,null,0,f.b,[l.k,f.d,[8,null],[2,f.a],[2,l.l]],{svgIcon:[0,"svgIcon"]},null),(n()(),l.qb(3,0,null,null,1,"mat-icon",[["class","microphone-peer-img mat-icon notranslate"],["role","img"]],[[2,"mat-icon-inline",null],[2,"mat-icon-no-color",null]],null,null,m.b,m.a)),l.pb(4,9158656,null,0,f.b,[l.k,f.d,[8,null],[2,f.a],[2,l.l]],{svgIcon:[0,"svgIcon"]},null)],(function(n,e){var t=e.component;n(e,2,0,t.buttons[0][t.videoContext.settings.video]),n(e,4,0,t.buttons[1][t.videoContext.settings.audio])}),(function(n,e){n(e,1,0,l.Cb(e,2).inline,"primary"!==l.Cb(e,2).color&&"accent"!==l.Cb(e,2).color&&"warn"!==l.Cb(e,2).color),n(e,3,0,l.Cb(e,4).inline,"primary"!==l.Cb(e,4).color&&"accent"!==l.Cb(e,4).color&&"warn"!==l.Cb(e,4).color)}))}function N(n){return l.Lb(0,[(n()(),l.qb(0,0,null,null,10,"mat-toolbar",[["class","top-toolbar mat-toolbar"]],[[2,"mat-toolbar-multiple-rows",null],[2,"mat-toolbar-single-row",null]],null,null,h.b,h.a)),l.pb(1,4243456,null,1,C.a,[l.k,s.a,u.d],null,null),l.Hb(603979776,1,{_toolbarRows:1}),(n()(),l.qb(3,0,null,0,2,"app-contact",[],null,null,null,g.b,g.a)),l.pb(4,114688,null,0,x.a,[l.h,w.a,y.a,l.z],{context:[0,"context"]},null),l.Db(131072,u.b,[l.h]),(n()(),l.qb(6,0,null,0,0,"div",[["class","example-spacer"]],null,null,null,null,null)),(n()(),l.gb(16777216,null,0,1,null,P)),l.pb(8,16384,null,0,u.l,[l.N,l.K],{ngIf:[0,"ngIf"]},null),(n()(),l.gb(16777216,null,0,1,null,S)),l.pb(10,16384,null,0,u.l,[l.N,l.K],{ngIf:[0,"ngIf"]},null)],(function(n,e){var t=e.component;n(e,4,0,l.Kb(e,4,0,l.Cb(e,5).transform(t.videoContext.contact))),n(e,8,0,t.videoContext.local),n(e,10,0,!t.videoContext.local)}),(function(n,e){n(e,0,0,l.Cb(e,1)._toolbarRows.length>0,0===l.Cb(e,1)._toolbarRows.length)}))}function M(n){return l.Lb(0,[(n()(),l.qb(0,0,null,null,1,"mat-spinner",[["class","mat-spinner mat-progress-spinner"],["mode","indeterminate"],["role","progressbar"]],[[2,"_mat-animation-noopable",null],[4,"width","px"],[4,"height","px"]],null,null,a.d,a.b)),l.pb(1,114688,null,0,c.d,[l.k,s.a,[2,u.d],[2,r.a],c.a],null,null)],(function(n,e){n(e,1,0)}),(function(n,e){n(e,0,0,l.Cb(e,1)._noopAnimations,l.Cb(e,1).diameter,l.Cb(e,1).diameter)}))}function z(n){return l.Lb(0,[(n()(),l.qb(0,0,null,null,4,"div",[["class","bottom-peer-block"]],null,null,null,null,null)),(n()(),l.qb(1,0,null,null,3,"button",[["class","phone-hangup"],["mat-fab",""]],[[1,"disabled",0],[2,"_mat-animation-noopable",null]],[[null,"click"]],(function(n,e,t){var l=!0;return"click"===e&&(l=!1!==n.component.clickIcon(2,t)&&l),l}),d.b,d.a)),l.pb(2,180224,null,0,b.b,[l.k,p.f,[2,r.a]],null,null),(n()(),l.qb(3,0,null,0,1,"mat-icon",[["class","mat-icon notranslate"],["role","img"],["svgIcon","phone-hangup"]],[[2,"mat-icon-inline",null],[2,"mat-icon-no-color",null]],null,null,m.b,m.a)),l.pb(4,9158656,null,0,f.b,[l.k,f.d,[8,null],[2,f.a],[2,l.l]],{svgIcon:[0,"svgIcon"]},null)],(function(n,e){n(e,4,0,"phone-hangup")}),(function(n,e){n(e,1,0,l.Cb(e,2).disabled||null,"NoopAnimations"===l.Cb(e,2)._animationMode),n(e,3,0,l.Cb(e,4).inline,"primary"!==l.Cb(e,4).color&&"accent"!==l.Cb(e,4).color&&"warn"!==l.Cb(e,4).color)}))}function D(n){return l.Lb(0,[(n()(),l.qb(0,0,null,null,0,"img",[["class","img-pulse"],["src","/assets/app-shell/Radio-1s-200px.svg"]],null,null,null,null,null))],null,null)}function j(n){return l.Lb(0,[(n()(),l.qb(0,0,null,null,14,"div",[["class","bottom-local-block"]],null,null,null,null,null)),(n()(),l.gb(16777216,null,null,1,null,D)),l.pb(2,16384,null,0,u.l,[l.N,l.K],{ngIf:[0,"ngIf"]},null),(n()(),l.qb(3,0,null,null,3,"button",[["class","bottom-peer-video"],["mat-mini-fab",""]],[[1,"disabled",0],[2,"_mat-animation-noopable",null]],[[null,"click"]],(function(n,e,t){var l=!0;return"click"===e&&(l=!1!==n.component.clickIcon(0,t)&&l),l}),d.b,d.a)),l.pb(4,180224,null,0,b.b,[l.k,p.f,[2,r.a]],null,null),(n()(),l.qb(5,0,null,0,1,"mat-icon",[["class","video-img mat-icon notranslate"],["role","img"]],[[2,"mat-icon-inline",null],[2,"mat-icon-no-color",null]],null,null,m.b,m.a)),l.pb(6,9158656,null,0,f.b,[l.k,f.d,[8,null],[2,f.a],[2,l.l]],{svgIcon:[0,"svgIcon"]},null),(n()(),l.qb(7,0,null,null,3,"button",[["class","phone-hangup"],["mat-mini-fab",""]],[[1,"disabled",0],[2,"_mat-animation-noopable",null]],[[null,"click"]],(function(n,e,t){var l=!0;return"click"===e&&(l=!1!==n.component.clickIcon(2,t)&&l),l}),d.b,d.a)),l.pb(8,180224,null,0,b.b,[l.k,p.f,[2,r.a]],null,null),(n()(),l.qb(9,0,null,0,1,"mat-icon",[["class","mat-icon notranslate"],["role","img"],["svgIcon","phone-hangup"]],[[2,"mat-icon-inline",null],[2,"mat-icon-no-color",null]],null,null,m.b,m.a)),l.pb(10,9158656,null,0,f.b,[l.k,f.d,[8,null],[2,f.a],[2,l.l]],{svgIcon:[0,"svgIcon"]},null),(n()(),l.qb(11,0,null,null,3,"button",[["class","bottom-peer-audio"],["mat-mini-fab",""]],[[1,"disabled",0],[2,"_mat-animation-noopable",null]],[[null,"click"]],(function(n,e,t){var l=!0;return"click"===e&&(l=!1!==n.component.clickIcon(1,t)&&l),l}),d.b,d.a)),l.pb(12,180224,null,0,b.b,[l.k,p.f,[2,r.a]],null,null),(n()(),l.qb(13,0,null,0,1,"mat-icon",[["class","microphone-img mat-icon notranslate"],["role","img"]],[[2,"mat-icon-inline",null],[2,"mat-icon-no-color",null]],null,null,m.b,m.a)),l.pb(14,9158656,null,0,f.b,[l.k,f.d,[8,null],[2,f.a],[2,l.l]],{svgIcon:[0,"svgIcon"]},null)],(function(n,e){var t=e.component;n(e,2,0,t.videoContext.className.pulse),n(e,6,0,t.buttons[0][t.videoContext.settings.video]),n(e,10,0,"phone-hangup"),n(e,14,0,t.buttons[1][t.videoContext.settings.audio])}),(function(n,e){n(e,3,0,l.Cb(e,4).disabled||null,"NoopAnimations"===l.Cb(e,4)._animationMode),n(e,5,0,l.Cb(e,6).inline,"primary"!==l.Cb(e,6).color&&"accent"!==l.Cb(e,6).color&&"warn"!==l.Cb(e,6).color),n(e,7,0,l.Cb(e,8).disabled||null,"NoopAnimations"===l.Cb(e,8)._animationMode),n(e,9,0,l.Cb(e,10).inline,"primary"!==l.Cb(e,10).color&&"accent"!==l.Cb(e,10).color&&"warn"!==l.Cb(e,10).color),n(e,11,0,l.Cb(e,12).disabled||null,"NoopAnimations"===l.Cb(e,12)._animationMode),n(e,13,0,l.Cb(e,14).inline,"primary"!==l.Cb(e,14).color&&"accent"!==l.Cb(e,14).color&&"warn"!==l.Cb(e,14).color)}))}function L(n){return l.Lb(0,[(n()(),l.qb(0,0,null,null,8,"mat-toolbar",[["class","bottom-toolbar mat-toolbar"]],[[2,"mat-toolbar-multiple-rows",null],[2,"mat-toolbar-single-row",null]],null,null,h.b,h.a)),l.Gb(512,null,u.y,u.z,[l.q,l.r,l.k,l.C]),l.pb(2,278528,null,0,u.j,[u.y],{klass:[0,"klass"],ngClass:[1,"ngClass"]},null),l.pb(3,4243456,null,1,C.a,[l.k,s.a,u.d],null,null),l.Hb(603979776,2,{_toolbarRows:1}),(n()(),l.gb(16777216,null,0,1,null,z)),l.pb(6,16384,null,0,u.l,[l.N,l.K],{ngIf:[0,"ngIf"]},null),(n()(),l.gb(16777216,null,0,1,null,j)),l.pb(8,16384,null,0,u.l,[l.N,l.K],{ngIf:[0,"ngIf"]},null)],(function(n,e){var t=e.component;n(e,2,0,"bottom-toolbar",t.videoContext.className),n(e,6,0,!t.videoContext.local),n(e,8,0,t.videoContext.local)}),(function(n,e){n(e,0,0,l.Cb(e,3)._toolbarRows.length>0,0===l.Cb(e,3)._toolbarRows.length)}))}function V(n){return l.Lb(0,[(n()(),l.qb(0,0,null,null,13,"div",[["class","video-container"]],null,[[null,"mousemove"]],(function(n,e,t){var l=!0;return"mousemove"===e&&(l=!1!==n.component.onMoveElementVideo(t)&&l),l}),null,null)),l.Gb(512,null,u.y,u.z,[l.q,l.r,l.k,l.C]),l.pb(2,278528,null,0,u.j,[u.y],{klass:[0,"klass"],ngClass:[1,"ngClass"]},null),(n()(),l.gb(16777216,null,null,1,null,N)),l.pb(4,16384,null,0,u.l,[l.N,l.K],{ngIf:[0,"ngIf"]},null),(n()(),l.qb(5,0,null,null,6,"div",[["class","main-video-container"]],null,null,null,null,null)),(n()(),l.gb(16777216,null,null,1,null,M)),l.pb(7,16384,null,0,u.l,[l.N,l.K],{ngIf:[0,"ngIf"]},null),(n()(),l.qb(8,0,[["videoElement",1]],null,3,"video",[["autoplay",""],["class","video-element"],["playsinline",""]],[[8,"srcObject",0],[8,"muted",0]],[[null,"loadeddata"],[null,"ended"]],(function(n,e,t){var o=!0,i=n.component;return"loadeddata"===e&&(o=!1!==i.onLoadedData(l.Cb(n,8))&&o),"ended"===e&&(o=!1!==i.onEnded()&&o),o}),null,null)),l.Gb(512,null,u.y,u.z,[l.q,l.r,l.k,l.C]),l.pb(10,278528,null,0,u.j,[u.y],{klass:[0,"klass"],ngClass:[1,"ngClass"]},null),l.Db(131072,u.b,[l.h]),(n()(),l.gb(16777216,null,null,1,null,L)),l.pb(13,16384,null,0,u.l,[l.N,l.K],{ngIf:[0,"ngIf"]},null)],(function(n,e){var t=e.component;n(e,2,0,"video-container",t.videoContext.className),n(e,4,0,t.toolbarVisibility),n(e,7,0,!t.videoContext.className.active),n(e,10,0,"video-element",t.videoContext.className),n(e,13,0,t.toolbarVisibility)}),(function(n,e){var t=e.component;n(e,8,0,l.Kb(e,8,0,l.Cb(e,11).transform(t.videoContext.stream)),t.videoContext.local)}))}var E=function(){function n(e,t){_classCallCheck(this,n),this.appContext=e,this.webRtcContext=t,this.localBadge="",this.subscriptions=[]}return _createClass(n,[{key:"ngOnInit",value:function(){var n=this;this.subscriptions.push(this.appContext.announcements.subscribe((function(e){var t=e.filter((function(n){return n.active})).length;n.localBadge=0==t?"":t+""})))}},{key:"onOpenView",value:function(){this.webRtcContext.handleView(!1)}}]),n}(),U=l.ob({encapsulation:0,styles:[["[_nghost-%COMP%]{position:absolute;z-index:8;left:10px;bottom:10px}.main-block[_ngcontent-%COMP%]{width:80px;display:flex;justify-content:center;align-items:center}button[_ngcontent-%COMP%]{background-color:transparent!important;color:#fff!important}"]],data:{}});function K(n){return l.Lb(0,[(n()(),l.qb(0,0,null,null,9,"div",[["class","outer-toolbar-block"]],null,null,null,null,null)),(n()(),l.qb(1,0,null,null,8,"div",[["class","main-block"]],null,null,null,null,null)),(n()(),l.qb(2,0,null,null,2,"app-contact",[],null,null,null,g.b,g.a)),l.pb(3,114688,null,0,x.a,[l.h,w.a,y.a,l.z],{context:[0,"context"]},null),l.Db(131072,u.b,[l.h]),(n()(),l.qb(5,0,null,null,0,"span",[["class","example-spacer"]],null,null,null,null,null)),(n()(),l.qb(6,0,null,null,3,"button",[["class","close-view"],["mat-mini-fab",""]],[[1,"disabled",0],[2,"_mat-animation-noopable",null]],[[null,"click"]],(function(n,e,t){var l=!0;return"click"===e&&(l=!1!==n.component.onOpenView()&&l),l}),d.b,d.a)),l.pb(7,180224,null,0,b.b,[l.k,p.f,[2,r.a]],null,null),(n()(),l.qb(8,0,null,0,1,"mat-icon",[["class","mat-icon notranslate"],["role","img"],["svgIcon","close-view"]],[[2,"mat-icon-inline",null],[2,"mat-icon-no-color",null]],null,null,m.b,m.a)),l.pb(9,9158656,null,0,f.b,[l.k,f.d,[8,null],[2,f.a],[2,l.l]],{svgIcon:[0,"svgIcon"]},null)],(function(n,e){var t=e.component;n(e,3,0,l.Kb(e,3,0,l.Cb(e,4).transform(t.appContext.user))),n(e,9,0,"close-view")}),(function(n,e){n(e,6,0,l.Cb(e,7).disabled||null,"NoopAnimations"===l.Cb(e,7)._animationMode),n(e,8,0,l.Cb(e,9).inline,"primary"!==l.Cb(e,9).color&&"accent"!==l.Cb(e,9).color&&"warn"!==l.Cb(e,9).color)}))}var T=l.ob({encapsulation:0,styles:[[".web-rtc-context-container[_ngcontent-%COMP%]{height:100%;display:flex;justify-content:stretch;align-items:stretch}app-video-channel[_ngcontent-%COMP%]{flex:1 1 0}app-video-channel.local[_ngcontent-%COMP%]{flex:0 0 0}@media (orientation:landscape){.web-rtc-context-container[_ngcontent-%COMP%]{flex-direction:row}}@media (orientation:portrait){.web-rtc-context-container[_ngcontent-%COMP%]{flex-direction:column}}"]],data:{}});function J(n){return l.Lb(0,[(n()(),l.qb(0,0,null,null,3,"app-video-channel",[],null,null,null,V,R)),l.Gb(512,null,u.y,u.z,[l.q,l.r,l.k,l.C]),l.pb(2,278528,null,0,u.j,[u.y],{ngClass:[0,"ngClass"]},null),l.pb(3,245760,null,0,k,[w.a,I.a,_.a,y.a,l.h,A.a,O],{videoContext:[0,"videoContext"]},null)],(function(n,e){n(e,2,0,e.context.$implicit.channelClass),n(e,3,0,e.context.$implicit)}),null)}function F(n){return l.Lb(0,[(n()(),l.qb(0,0,null,null,1,"app-outer-toolbar",[],null,null,null,K,U)),l.pb(1,114688,null,0,E,[w.a,O],null,null)],(function(n,e){n(e,1,0)}),null)}function G(n){return l.Lb(0,[(n()(),l.qb(0,0,null,null,2,"div",[["class","web-rtc-context-container"]],null,null,null,null,null)),(n()(),l.gb(16777216,null,null,1,null,J)),l.pb(2,278528,null,0,u.k,[l.N,l.K,l.q],{ngForOf:[0,"ngForOf"]},null),(n()(),l.gb(16777216,null,null,1,null,F)),l.pb(4,16384,null,0,u.l,[l.N,l.K],{ngIf:[0,"ngIf"]},null)],(function(n,e){var t=e.component;n(e,2,0,t.context.videoCollection),n(e,4,0,t.localToolbar)}),null)}var B=t("mrSG"),H=t("iInd"),W=t("pLZG"),Z=t("fvN4"),Q=t("2Vo4"),X=t("XNiG"),$=function(){function n(e,t,l,o,i){_classCallCheck(this,n),this.router=e,this.webRtcService=t,this.appContext=l,this.database=o,this.statusColor=i,this.progress=!0,this.subscriptions=[],this.duplicateCall=JSON.parse(window.localStorage.getItem("duplicateCall")),this.optimizeCall=JSON.parse(window.localStorage.getItem("optimizeCall")),this.video=JSON.parse(window.localStorage.getItem("videoinput")),this.micro=JSON.parse(window.localStorage.getItem("audioinput")),this.audio=JSON.parse(window.localStorage.getItem("audiooutput")),this.flexDirection="column",this.constraints={audio:{deviceId:!(!this.audio||!this.audio.deviceId)&&this.audio.deviceId,echoCancellation:!0,autoGainControl:!0,noiseSuppression:!0},video:{deviceId:!(!this.video||!this.video.deviceId)&&this.video.deviceId}}}return _createClass(n,[{key:"ngOnInit",value:function(){this.router.events.pipe(Object(W.a)((function(n){return n instanceof H.g}))).subscribe((function(n){})),this.startConnections()}},{key:"ngAfterViewInit",value:function(){this.progress=!1}},{key:"ngOnDestroy",value:function(){this.subscriptions.forEach((function(n){return n.unsubscribe()}))}},{key:"handleDescriptor",value:function(n,e){var t=e.val();t.type.indexOf("answers")>-1&&this.setDescriptor(n.pcConnection,t),t.type.indexOf("offers")>-1&&this.startConnections(t)}},{key:"dispatchDescriptor",value:function(n){var e=this,t=this,l=n.descriptor,o=n.candidates;function i(e){/answers|offers\/implicit/.test(e.type)?t.database.sendDescriptor(e):t.webRtcService.sendOffer(n),e.type.indexOf("offers")>-1&&t.setAnswerListener(n)}l.optimize&&o.length?(l.candidates=this.setCandidates(l,o),i(l)):l.optimize||(i(l),o.length&&this.setCandidates(l,o).forEach((function(n){e.database.sendDescriptor(n).catch(e.onError)})))}},{key:"setCandidates",value:function(n,e){var t=this,l=[];return e.forEach((function(e){l.push(new Z.b({wid:n.wid,contact:n.contact,date:Date.now(),sender:t.appContext.user.value,descId:n.messId,type:"candidates",desc:e,active:!0,optimize:n.optimize,uid:n.uid}))})),l}},{key:"setAnswerListener",value:function(n){this.database.getRef("/web-rtc/answers/"+this.appContext.appUser.uid).orderByChild("descId").equalTo(n.descriptor.messId).once("child_added",this.handleDescriptor.bind(this,n))}},{key:"setImplicitListener",value:function(n){this.database.getRef("/web-rtc/offers/implicit/"+this.appContext.appUser.uid).orderByChild("descId").equalTo(n).once("child_added",this.handleDescriptor.bind(this,n))}},{key:"startConnections",value:function(n){return B.__awaiter(this,void 0,void 0,regeneratorRuntime.mark((function e(){var t,l,o,i,a=this;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=this.appContext.webRtcContexts.getContext(this.appContext.contextId)){e.next=3;break}return e.abrupt("return");case 3:if(e.t0=t.localStream,e.t0){e.next=8;break}return e.next=7,navigator.mediaDevices.getUserMedia(this.constraints);case 7:t.localStream=e.sent;case 8:l=n?n.sender:t.sender,(o=n?[l]:[l].concat(t.receivers.value))&&(i=o.findIndex((function(n){return n.uid===a.appContext.user.value.uid})),o.forEach((function(e,l){var o,c,s,u=a.appContext.appUser.uid===e.uid,r=!n&&(t.uid===a.appContext.appUser.uid||i<l);(i<=l||!r&&0==l)&&((s=t.webRtcConnections[e.uid]=new Z.g({uid:e.uid})).webRtcContext=t,s.uid=e.uid,s.videoContext=new Z.f({wid:t.wid,contact:new Q.a(u?a.appContext.appUser:e),channelClass:u?"local":"remote",messageUrl:t.desc.messageUrl,className:u?(o={},_defineProperty(o,e.uid+" local video-context",!0),_defineProperty(o,"active",!1),_defineProperty(o,"fixed",!1),_defineProperty(o,"closed",!1),_defineProperty(o,"pulse",r),o):(c={},_defineProperty(c,e.uid+" remote video-context",!0),_defineProperty(c,"active",!1),c),stream:new Q.a(u?t.localStream:void 0),local:u,settings:{type:"settings",video:1,audio:1},dataChannel:{data:new X.a,channel:void 0}}),u&&t.videoCollection.push(s.videoContext)),i<l||!r&&0==l?(s.pcConnection=new SimplePeer({initiator:r,channelName:e.uid,config:a.appContext.stunTurnConfig[r?window.localStorage.getItem("stunTurn"):t.desc.stun],stream:t.localStream}),s.pcConnection._debug=console.log,r&&(s.videoContext.dataChannel.channel=s.pcConnection._channel),s.pcConnection.on("signal",(function(l){return B.__awaiter(a,void 0,void 0,regeneratorRuntime.mark((function o(){var i,a;return regeneratorRuntime.wrap((function(o){for(;;)switch(o.prev=o.next){case 0:l.type?("offer"===l.type?s.descriptor=new Z.d({type:t.uid===this.appContext.appUser.uid?"offers/explicit":"offers/implicit",action:"offered",contact:e,uid:this.appContext.appUser.uid,wid:t.wid,messageUrl:t.uid===this.appContext.appUser.uid?"/messages/"+e.uid+"/"+t.wid:"",receivers:r?t.receivers.value:[e],sender:this.appContext.appUser,stun:r?window.localStorage.getItem("stunTurn"):t.desc.stun,desc:l,descId:t.wid+this.appContext.appUser.uid,optimize:r?JSON.parse(window.localStorage.getItem("optimizeCall")):t.desc.optimize,candidates:!!JSON.parse(window.localStorage.getItem("optimizeCall"))&&[]}):"answer"===l.type&&(s.descriptor=new Z.a({type:"answers",active:!0,contact:e,uid:t.desc.uid,descId:n?n.messId:t.desc.messId,wid:t.wid,receivers:[n?n.sender:t.sender],sender:this.appContext.appUser,desc:l,optimize:t.desc.optimize,candidates:!!t.desc.optimize&&[]})),this.dispatchDescriptor(s)):l.candidate&&((i=s.descriptor)?(a=new Z.b({wid:i.wid,contact:e,date:Date.now(),sender:this.appContext.user.value,descId:i.messId,type:"candidates",desc:l.candidate,active:!0,optimize:i.optimize,uid:i.uid}),i.optimize?i.candidates.push(a):this.database.sendDescriptor(a).catch(this.onError)):s.candidates.push(l.candidate));case 1:case"end":return o.stop()}}),o,this)})))})),s.pcConnection._pc.addEventListener("icegatheringstatechange",(function(n){if("complete"===n.target.iceGatheringState){var e=s.descriptor;e&&e.optimize&&(e.candidates.length?(/answers|offers\/implicit/.test(e.type)&&a.database.sendDescriptor(e).then((function(){console.log("\u0421\u0431\u043e\u0440\u043a\u0430 \u043a\u0430\u043d\u0434\u0438\u0434\u0430\u0442\u043e\u0432 \u0437\u0430\u0432\u0435\u0440\u0448\u0435\u043d\u0430. \u041a\u0430\u043d\u0434\u0438\u0434\u0430\u0442\u044b \u043e\u0442\u043f\u0440\u0430\u0432\u043b\u0435\u043d\u044b.")})).catch(a.onError),/offers\/explicit/.test(e.type)&&a.webRtcService.sendOffer(s),e.type.indexOf("offers")>-1&&a.setAnswerListener(s)):(a.onError("\u0421\u0431\u043e\u0439 \u043e\u0442\u043f\u0440\u0430\u0432\u043a\u0438 \u043a\u0430\u043d\u0434\u0438\u0434\u0430\u0442\u043e\u0432 \u0432 \u0441\u043e\u0431\u044b\u0442\u0438\u0438 icegatheringstatechange."),a.setAnnouncement({type:"incompatibilityFailure",desc:{text:"\u0421\u0431\u043e\u0439 \u043d\u0435\u0441\u043e\u0432\u043c\u0435\u0441\u0442\u0438\u043c\u043e\u0441\u0442\u0438."}})))}})),s.pcConnection._pc.addEventListener("connectionstatechange",(function(n){var e=s.videoContext.contact.value;e.statusColor=a.statusColor.statusColors.webrtc.perConnectionStates[n.target.connectionState],s.videoContext.contact.next(e)})),s.pcConnection.on("connect",(function(){r||(s.videoContext.dataChannel.channel=s.pcConnection._channel),s.pcConnection.send(JSON.stringify(a.appContext.localVideoAudio))})),s.pcConnection.on("data",(function(n){s.videoContext.dataChannel.data.next(JSON.parse(n))})),s.pcConnection.on("stream",(function(n){s.videoContext.stream.next(n),t.videoCollection.push(s.videoContext),a.appContext.appChangeRef.markForCheck()})),s.pcConnection.on("close",(function(n){})),s.pcConnection.on("error",(function(n){})),r||0!==l||a.setDescriptor(s.pcConnection,n||t.desc)):i>l&&a.setImplicitListener(t.wid+e.uid)}))),this.appContext.appChangeRef.markForCheck();case 11:case"end":return e.stop()}}),e,this)})))}},{key:"setDescriptor",value:function(n,e){var t=this;n.signal(e.desc),/answers/.test(e.type)?this.database.deleteDescriptor({descriptor:e}).then((function(){})).catch((function(n){return t.onError(n)})):(this.database.setDescriptorOptions({descriptor:e,data:{active:!1,action:"accepted"}}).then((function(n){})).catch((function(n){return t.onError(n)})),"offers/explicit"===e.type&&[{path:"/messages/"+this.appContext.appUser.uid+"/"+e.wid+"/actions",data:_defineProperty({},e.contact.uid,"accepted")},{path:"/messages/"+e.sender.uid+"/"+e.wid+"/actions",data:_defineProperty({},e.contact.uid,"accepted")}].forEach((function(n){t.database.changeMessage(n.path,n.data)}))),B.__awaiter(t,void 0,void 0,regeneratorRuntime.mark((function t(){return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.checkCandidates(e,n);case 2:case"end":return t.stop()}}),t,this)})))}},{key:"requestCandidates",value:function(n){return B.__awaiter(this,void 0,void 0,regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.database.database.ref("/web-rtc/candidates/".concat(this.appContext.user.value.uid)).orderByChild("descId").equalTo(n.messId).once("value"));case 1:case"end":return e.stop()}}),e,this)})))}},{key:"checkCandidates",value:function(n,e){var t=this,l=this;return new Promise((function(e,l){n.optimize?o.bind(t,n.candidates,e)():t.requestCandidates(n).then((function(n){var l=n.val();l&&o.bind(t,Object.values(l),e)()})).catch(t.onError)}));function o(n,t){n.forEach((function(n){e.signal({candidate:n.desc}),l.database.deleteDescriptor({descriptor:n}).then((function(){})).catch((function(n){return l.onError(n)}))})),t()}}},{key:"setAnnouncement",value:function(n){this.appContext.announcements.next([n].concat(this.appContext.announcements.value)),this.appContext.appChangeRef.markForCheck()}},{key:"onError",value:function(n){console.log(n)}}]),n}(),Y=l.ob({encapsulation:0,styles:[[".web-rtc-component-container[_ngcontent-%COMP%]{height:100%}.startScreen[_ngcontent-%COMP%]{position:absolute;height:100%;width:100%;display:flex;justify-content:center;align-items:center}"]],data:{}});function nn(n){return l.Lb(0,[(n()(),l.qb(0,0,null,null,2,"div",[["class","startScreen"]],null,null,null,null,null)),(n()(),l.qb(1,0,null,null,1,"mat-progress-spinner",[["class","mat-progress-spinner"],["color","primary"],["mode","indeterminate"],["role","progressbar"]],[[2,"_mat-animation-noopable",null],[4,"width","px"],[4,"height","px"],[1,"aria-valuemin",0],[1,"aria-valuemax",0],[1,"aria-valuenow",0],[1,"mode",0]],null,null,a.c,a.a)),l.pb(2,114688,null,0,c.b,[l.k,s.a,[2,u.d],[2,r.a],c.a],{color:[0,"color"],mode:[1,"mode"]},null)],(function(n,e){n(e,2,0,"primary","indeterminate")}),(function(n,e){n(e,1,0,l.Cb(e,2)._noopAnimations,l.Cb(e,2).diameter,l.Cb(e,2).diameter,"determinate"===l.Cb(e,2).mode?0:null,"determinate"===l.Cb(e,2).mode?100:null,"determinate"===l.Cb(e,2).mode?l.Cb(e,2).value:null,l.Cb(e,2).mode)}))}function en(n){return l.Lb(0,[(n()(),l.qb(0,0,null,null,1,"app-web-rtc-context",[],null,null,null,G,T)),l.pb(1,114688,null,0,O,[l.z],{context:[0,"context"]},null)],(function(n,e){n(e,1,0,e.context.$implicit)}),null)}function tn(n){return l.Lb(0,[(n()(),l.qb(0,0,null,null,6,"div",[["class","web-rtc-component-container"]],null,null,null,null,null)),l.Gb(512,null,u.A,u.B,[l.k,l.r,l.C]),l.pb(2,278528,null,0,u.o,[u.A],{ngStyle:[0,"ngStyle"]},null),l.Eb(3,{"flex-direction":0}),(n()(),l.gb(16777216,null,null,2,null,en)),l.pb(5,278528,null,0,u.k,[l.N,l.K,l.q],{ngForOf:[0,"ngForOf"]},null),l.Db(131072,u.b,[l.h])],(function(n,e){var t=e.component,o=n(e,3,0,t.flexDirection);n(e,2,0,o),n(e,5,0,l.Kb(e,5,0,l.Cb(e,6).transform(t.appContext.webRtcContexts.contexts)))}),null)}function ln(n){return l.Lb(0,[(n()(),l.gb(16777216,null,null,1,null,nn)),l.pb(1,16384,null,0,u.l,[l.N,l.K],{ngIf:[0,"ngIf"]},null),(n()(),l.gb(16777216,null,null,1,null,tn)),l.pb(3,16384,null,0,u.l,[l.N,l.K],{ngIf:[0,"ngIf"]},null)],(function(n,e){var t=e.component;n(e,1,0,t.progress),n(e,3,0,!t.progress)}),null)}var on=l.mb("app-web-rtc",$,(function(n){return l.Lb(0,[(n()(),l.qb(0,0,null,null,1,"app-web-rtc",[],null,null,null,ln,Y)),l.pb(1,4440064,null,0,$,[H.o,I.a,w.a,y.a,_.a],null,null)],(function(n,e){n(e,1,0)}),null)}),{},{},[]),an=t("NcP4"),cn=t("POq0"),sn=t("QQfA"),un=t("IP0z"),rn=t("JjoW"),dn=t("Mz6y"),bn=t("cUpR"),pn=t("Xd0L"),mn=t("gavF"),fn=t("/Co4"),vn=t("s7LF"),hn=t("/q54"),Cn=function n(){_classCallCheck(this,n)},gn=t("igqZ"),xn=t("HsOI"),wn=t("zMNK"),yn=t("hOhj"),kn=t("oapL"),In=t("ZwOa"),_n=t("8P0U"),An=t("elxJ"),On=t("rWV4"),Rn=t("mkRZ"),qn=t("pBi1"),Pn=t("lT8R"),Sn=t("7of8"),Nn=t("VDRc"),Mn=t("ura0"),zn=t("Nhcz"),Dn=t("u9T3"),jn=t("Gcy5");t.d(e,"WebRtcModuleNgFactory",(function(){return Ln}));var Ln=l.nb(o,[],(function(n){return l.zb([l.Ab(512,l.j,l.Z,[[8,[i.a,on,an.a]],[3,l.j],l.v]),l.Ab(4608,u.n,u.m,[l.s,[2,u.D]]),l.Ab(4608,cn.c,cn.c,[]),l.Ab(4608,sn.c,sn.c,[sn.i,sn.e,l.j,sn.h,sn.f,l.p,l.x,u.d,un.b,[2,u.h]]),l.Ab(5120,sn.j,sn.k,[sn.c]),l.Ab(5120,rn.a,rn.b,[sn.c]),l.Ab(5120,dn.b,dn.c,[sn.c]),l.Ab(4608,bn.e,pn.c,[[2,pn.g],[2,pn.l]]),l.Ab(4608,pn.b,pn.b,[]),l.Ab(5120,mn.a,mn.d,[sn.c]),l.Ab(5120,fn.b,fn.c,[sn.c]),l.Ab(4608,vn.e,vn.e,[]),l.Ab(4608,vn.w,vn.w,[]),l.Ab(5120,l.b,(function(n,e){return[hn.j(n,e)]}),[u.d,l.z]),l.Ab(1073742336,u.c,u.c,[]),l.Ab(1073742336,H.s,H.s,[[2,H.x],[2,H.o]]),l.Ab(1073742336,Cn,Cn,[]),l.Ab(1073742336,un.a,un.a,[]),l.Ab(1073742336,pn.l,pn.l,[[2,pn.d],[2,bn.f]]),l.Ab(1073742336,C.b,C.b,[]),l.Ab(1073742336,f.c,f.c,[]),l.Ab(1073742336,gn.c,gn.c,[]),l.Ab(1073742336,cn.d,cn.d,[]),l.Ab(1073742336,xn.e,xn.e,[]),l.Ab(1073742336,wn.e,wn.e,[]),l.Ab(1073742336,s.b,s.b,[]),l.Ab(1073742336,yn.b,yn.b,[]),l.Ab(1073742336,sn.g,sn.g,[]),l.Ab(1073742336,pn.v,pn.v,[]),l.Ab(1073742336,pn.t,pn.t,[]),l.Ab(1073742336,pn.q,pn.q,[]),l.Ab(1073742336,rn.d,rn.d,[]),l.Ab(1073742336,p.a,p.a,[]),l.Ab(1073742336,dn.e,dn.e,[]),l.Ab(1073742336,b.c,b.c,[]),l.Ab(1073742336,kn.c,kn.c,[]),l.Ab(1073742336,In.b,In.b,[]),l.Ab(1073742336,_n.c,_n.c,[]),l.Ab(1073742336,c.c,c.c,[]),l.Ab(1073742336,An.d,An.d,[]),l.Ab(1073742336,On.j,On.j,[]),l.Ab(1073742336,v.b,v.b,[]),l.Ab(1073742336,mn.c,mn.c,[]),l.Ab(1073742336,mn.b,mn.b,[]),l.Ab(1073742336,fn.e,fn.e,[]),l.Ab(1073742336,Rn.a,Rn.a,[]),l.Ab(1073742336,qn.d,qn.d,[]),l.Ab(1073742336,qn.c,qn.c,[]),l.Ab(1073742336,Pn.a,Pn.a,[]),l.Ab(1073742336,Sn.a,Sn.a,[]),l.Ab(1073742336,vn.v,vn.v,[]),l.Ab(1073742336,vn.s,vn.s,[]),l.Ab(1073742336,hn.c,hn.c,[]),l.Ab(1073742336,Nn.a,Nn.a,[]),l.Ab(1073742336,Mn.c,Mn.c,[]),l.Ab(1073742336,zn.a,zn.a,[]),l.Ab(1073742336,Dn.a,Dn.a,[[2,hn.g],l.z]),l.Ab(1073742336,jn.a,jn.a,[]),l.Ab(1073742336,o,o,[]),l.Ab(1024,H.m,(function(){return[[{path:"",component:$}]]}),[])])}))}}]);
//# sourceMappingURL=20-es5.3889a6cd6eeae1c4fb7f.js.map